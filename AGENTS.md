# AGENTS.md — notes for contributors/agents

Этот файл фиксирует практические знания о проекте, полученные при работе с кодовой базой.

## 1) Что это за проект
- Django backend для ведения дневника выращивания растений и Telegram-бота.
- Основные доменные зоны:
  - `catalogs` — справочники типов/сортов/этапов/операций;
  - `diary` — пользовательские растения, события, расчеты задач;
  - `bot` — Telegram-команды и webhook API;
  - `core` — настройки и маршруты проекта.

## 2) Структура, важная для изменений
- Корень репо: `/workspace/backend`.
- Django project package находится в `backend/` (то есть `manage.py` лежит в `backend/manage.py`).
- Ключевые файлы по бизнес-логике:
  - `backend/catalogs/models.py` — модели справочников;
  - `backend/diary/models.py` — модель `Plant` с логикой периодов и операций;
  - `backend/bot/bot.py` — команды Telegram-бота;
  - `backend/catalogs/admin.py` и `backend/diary/admin.py` — отображение в админке.

## 3) Семантика периодов (ВАЖНО)
В проекте используются две разные сущности:
- `sowing_period` — период **посева/посадки семян на рассаду**;
- `planting_period` — период **высадки рассады в грунт**.

Не смешивать эти понятия в UX/текстах/фильтрации.

Практический ориентир:
- команда `/planting` должна отражать готовность к **высадке в грунт**, то есть опираться на `planting_period`.

## 4) Формат периодов
- Ожидается строка вида: `DD.MM-DD.MM`, где месяц в римской записи `I..XII`.
- Валидация реализована regex-валидаторами в моделях каталогов.

## 5) Миграции и данные
- В истории есть миграции:
  - `0005_alter_planting_period_labels.py`
  - `0006_add_sowing_period_and_restore_planting_period.py`
- Они отражают эволюцию разделения «период посадки» и «период высадки».
- Перед новыми изменениями в этой области нужно внимательно проверять согласованность:
  - моделей,
  - админки,
  - Telegram-команд,
  - текстов валидации/лейблов,
  - миграций.

## 6) Локальный запуск и ограничения окружения
- Для запуска management-команд нужны env-переменные как минимум:
  - `SECRET_KEY`
  - `BOT_TOKEN`
- В текущем рабочем окружении встречалась проблема импорта `async_timeout` (через цепочку зависимостей `aiohttp/aiogram` при загрузке URLConf), из-за чего `manage.py` команды могут падать до выполнения.
- Если автогенерация миграций недоступна из-за окружения, допустимо подготовить миграцию вручную в стиле существующих файлов, но обязательно проверить синтаксис.

## 7) Рекомендуемые проверки перед коммитом
- Минимум: компиляция измененных Python-файлов:
  - `python -m compileall <список файлов>`
- Если окружение позволяет:
  - `python backend/manage.py makemigrations --check`
  - `python backend/manage.py test`

## 8) Практические правила для правок
- Изменения в доменной терминологии всегда проводить сквозно:
  - модели,
  - админка,
  - бот-тексты,
  - миграции,
  - документация.
- Для `Plant` при добавлении новых периодов/атрибутов сохранять fallback-логику «сорт → тип», если это ожидаемое поведение домена.
